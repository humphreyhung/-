@{
    ViewData["Title"] = "提案詳情";
}

<div class="project-detail-container">
    <div class="project-header">
        <h1 id="projectTitleDisplay"><span contenteditable="false" class="editable-field" id="projectTitle"></span></h1>
        <p class="project-category" id="projectCategoryDisplay"><span contenteditable="false" class="editable-field" id="projectCategory"></span></p>
    </div>

    <div class="project-content">
        <div class="project-image">
            <img id="projectImage" src="" alt="專案主圖">
        </div>

        <div class="project-info">
            <div class="info-section">
                <h2>專案簡介</h2>
                <p id="projectDescriptionDisplay"><span contenteditable="false" class="editable-field" id="projectDescription"></span></p>
            </div>

            <div class="info-section">
                <h2>募資進度</h2>
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <div class="progress-info">
                    <span class="current-amount" id="currentAmountDisplay">NT$ <span contenteditable="false" class="editable-field" id="currentAmount"></span></span>
                    <span class="target-amount" id="targetAmountDisplay">目標 NT$ <span contenteditable="false" class="editable-field" id="targetAmount"></span></span>
                </div>
            </div>

            <div class="info-section">
                <h2>專案時程</h2>
                <p>開始日期：<span contenteditable="false" class="editable-field" id="startDateDisplay"></span></p>
                <p>結束日期：<span contenteditable="false" class="editable-field" id="endDateDisplay"></span></p>
            </div>

            <div class="info-section">
                <h2>提案者資訊</h2>
                <p>姓名：<span contenteditable="false" class="editable-field" id="proposerName"></span></p>
                <p>聯絡信箱：<span contenteditable="false" class="editable-field" id="proposerEmail"></span></p>
                <p>聯絡電話：<span contenteditable="false" class="editable-field" id="proposerPhone"></span></p>
            </div>

            <div class="info-section">
                <h2>專案內容</h2>
                <div class="project-description" id="projectContentDisplay"><span contenteditable="false" class="editable-field" id="projectContent"></span></div>
            </div>

            <div class="info-section">
                <h2>相關連結</h2>
                <p><a id="relatedWebsiteLink" href="" target="_blank"><span contenteditable="false" class="editable-field" id="relatedWebsite"></span></a></p>
                <p><a id="videoUrlLink" href="" target="_blank"><span contenteditable="false" class="editable-field" id="videoUrl"></span></a></p>
            </div>
        </div>
    </div>
    <div class="edit-actions">
        <button id="editButton" class="edit-btn">編輯內容</button>
        <button id="saveButton" class="save-btn" style="display:none;">儲存更改</button>
    </div>
</div>

<style>
    .project-detail-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .project-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .project-header h1 {
        font-size: 2.5rem;
        color: #333;
        margin-bottom: 1rem;
    }

    .project-category {
        font-size: 1.2rem;
        color: #6A994E;
        font-weight: 500;
    }

    .project-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
    }

    .project-image img {
        width: 100%;
        height: auto;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .project-info {
        background: #ffffff;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .info-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #e9ecef;
    }

    .info-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .info-section h2 {
        color: #333;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    .progress {
        height: 100%;
        background: #6A994E;
        transition: width 0.3s ease;
    }

    .progress-info {
        display: flex;
        justify-content: space-between;
        color: #666;
    }

    .current-amount {
        color: #6A994E;
        font-weight: 600;
    }

    .project-description {
        line-height: 1.6;
        color: #666;
    }

    .project-description p {
        margin-bottom: 1rem;
    }

    .info-section a {
        color: #6A994E;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .info-section a:hover {
        color: #718355;
        text-decoration: underline;
    }

    @@media (max-width: 768px) {
        .project-detail-container {
            padding: 1rem;
        }

        .project-content {
            grid-template-columns: 1fr;
        }

        .project-header h1 {
            font-size: 2rem;
        }
    }

    .edit-actions {
        text-align: center;
        margin-top: 2rem;
    }

    .edit-btn, .save-btn {
        padding: 0.8rem 1.5rem;
        font-size: 1rem;
        cursor: pointer;
        border-radius: 5px;
        border: none;
        margin: 0 0.5rem;
        transition: background-color 0.3s ease;
    }

    .edit-btn {
        background-color: #007bff;
        color: white;
    }

    .edit-btn:hover {
        background-color: #0056b3;
    }

    .save-btn {
        background-color: #28a745;
        color: white;
    }

    .save-btn:hover {
        background-color: #218838;
    }

    .editable-field {
        border: 1px solid transparent;
        padding: 2px;
        transition: border-color 0.3s ease;
    }

    .editable-field[contenteditable="true"] {
        border-color: #ccc;
        background-color: #f9f9f9;
    }
</style>

<script>
    let projectData = {}; // 全局變數，用於儲存當前專案資料

    document.addEventListener('DOMContentLoaded', function() {
        const projectDataJson = sessionStorage.getItem('newProjectData');
        if (projectDataJson) {
            projectData = JSON.parse(projectDataJson); // 載入資料到全局變數
            renderProjectDetails(projectData);

            // 清除 sessionStorage 中的資料，因為已經顯示了
            // sessionStorage.removeItem('newProjectData'); // 移除此行，讓資料保留
        } else {
            console.error('未找到專案資料');
            // window.location.href = '/Home/CreateProject'; 
        }
    });

    function renderProjectDetails(data) {
        document.getElementById('projectTitle').textContent = data.title;
        document.getElementById('projectCategory').textContent = data.category;
        document.getElementById('projectImage').src = data.imageUrl;
        document.getElementById('projectDescription').textContent = data.description;
        
        document.getElementById('currentAmount').textContent = data.currentAmount.toLocaleString();
        document.getElementById('targetAmount').textContent = data.targetAmount.toLocaleString();
        const progress = (data.currentAmount / data.targetAmount) * 100;
        document.getElementById('progressBar').style.width = progress.toFixed(0) + '%';

        document.getElementById('startDateDisplay').textContent = new Date(data.startDate).toLocaleDateString();
        document.getElementById('endDateDisplay').textContent = new Date(data.endDate).toLocaleDateString();
        
        document.getElementById('proposerName').textContent = data.proposerName;
        document.getElementById('proposerEmail').textContent = data.proposerEmail;
        document.getElementById('proposerPhone').textContent = data.proposerPhone;
        document.getElementById('projectContent').textContent = data.projectContent;

        const relatedWebsiteLink = document.getElementById('relatedWebsiteLink');
        relatedWebsiteLink.href = data.relatedWebsite;
        document.getElementById('relatedWebsite').textContent = data.relatedWebsite; // 顯示實際網址

        const videoUrlLink = document.getElementById('videoUrlLink');
        videoUrlLink.href = data.videoUrl;
        document.getElementById('videoUrl').textContent = data.videoUrl; // 顯示實際網址
    }

    // 編輯模式切換
    document.getElementById('editButton').addEventListener('click', function() {
        toggleEditMode(true);
    });

    document.getElementById('saveButton').addEventListener('click', function() {
        saveChanges();
        toggleEditMode(false);
    });

    function toggleEditMode(isEditing) {
        const editableFields = document.querySelectorAll('.editable-field');
        editableFields.forEach(field => {
            field.contentEditable = isEditing;
            field.style.border = isEditing ? '1px solid #ccc' : '1px solid transparent';
            field.style.backgroundColor = isEditing ? '#f9f9f9' : 'transparent';
        });

        document.getElementById('editButton').style.display = isEditing ? 'none' : 'inline-block';
        document.getElementById('saveButton').style.display = isEditing ? 'inline-block' : 'none';
    }

    function saveChanges() {
        // 從可編輯欄位獲取新值
        projectData.title = document.getElementById('projectTitle').textContent;
        projectData.category = document.getElementById('projectCategory').textContent;
        projectData.description = document.getElementById('projectDescription').textContent;
        projectData.targetAmount = parseFloat(document.getElementById('targetAmount').textContent.replace(/[^0-9.-]+/g,""));
        projectData.currentAmount = parseFloat(document.getElementById('currentAmount').textContent.replace(/[^0-9.-]+/g,""));
        projectData.startDate = new Date(document.getElementById('startDateDisplay').textContent);
        projectData.endDate = new Date(document.getElementById('endDateDisplay').textContent);
        projectData.proposerName = document.getElementById('proposerName').textContent;
        projectData.proposerEmail = document.getElementById('proposerEmail').textContent;
        projectData.proposerPhone = document.getElementById('proposerPhone').textContent;
        projectData.projectContent = document.getElementById('projectContent').textContent;
        projectData.relatedWebsite = document.getElementById('relatedWebsite').textContent;
        projectData.videoUrl = document.getElementById('videoUrl').textContent;

        // 更新 sessionStorage
        sessionStorage.setItem('newProjectData', JSON.stringify(projectData));

        // 重新渲染顯示（以防有格式化需求）
        renderProjectDetails(projectData);
        alert('更改已儲存！');
    }

    function shareProject() {
        const projectDataJson = sessionStorage.getItem('newProjectData');
        if (!projectDataJson) {
            alert('無法分享：未找到專案資料');
            return;
        }
        const projectData = JSON.parse(projectDataJson);

        if (navigator.share) {
            navigator.share({
                title: projectData.title,
                text: projectData.description,
                url: window.location.href
            })
            .catch(error => console.log('Error sharing:', error));
        } else {
            const dummy = document.createElement('input');
            document.body.appendChild(dummy);
            dummy.value = window.location.href;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            alert('連結已複製到剪貼簿！');
        }
    }

    function selectReward(rewardId) {
        const projectDataJson = sessionStorage.getItem('newProjectData');
        if (!projectDataJson) {
            alert('無法選擇回饋：未找到專案資料');
            return;
        }
        const projectData = JSON.parse(projectDataJson);
        window.location.href = '/Home/Sponsor?id=' + (projectData.id || 0) + '&rewardId=' + rewardId; 
    }
</script> 